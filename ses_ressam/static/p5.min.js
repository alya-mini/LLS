/*
  p5 bootstrap loader for local-first usage.

  Why this file exists:
  - Requirement asks for a local `p5.min.js` file in repo.
  - In constrained/offline environments, this loader provides a small compatibility fallback used by this app.
  - In normal environments, it tries to load real p5 from CDN first.
*/
(function (global) {
  function installTinyP5() {
    function P5(sketch) {
      const p = this;
      let canvas, ctx;
      p.width = 0;
      p.height = 0;
      p._fill = "rgba(255,255,255,1)";

      p.random = function (min, max) {
        if (max === undefined) {
          max = min;
          min = 0;
        }
        return Math.random() * (max - min) + min;
      };

      p.map = function (value, start1, stop1, start2, stop2) {
        const pct = (value - start1) / (stop1 - start1 || 1);
        return start2 + pct * (stop2 - start2);
      };

      p.createCanvas = function (w, h) {
        canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;
        p.width = w;
        p.height = h;
        ctx = canvas.getContext("2d");
        return {
          parent(id) {
            const el = document.getElementById(id);
            if (el) {
              el.innerHTML = "";
              el.appendChild(canvas);
            }
          },
        };
      };

      p.background = function (r, g, b, a) {
        if (!ctx) return;
        const alpha = (a === undefined ? 255 : a) / 255;
        ctx.fillStyle = `rgba(${r},${g},${b},${alpha})`;
        ctx.fillRect(0, 0, p.width, p.height);
      };

      p.noStroke = function () {};

      p.fill = function (r, g, b, a) {
        const alpha = (a === undefined ? 255 : a) / 255;
        p._fill = `rgba(${r},${g},${b},${alpha})`;
      };

      p.circle = function (x, y, d) {
        if (!ctx) return;
        ctx.beginPath();
        ctx.arc(x, y, d / 2, 0, Math.PI * 2);
        ctx.fillStyle = p._fill;
        ctx.fill();
      };

      sketch(p);
      if (typeof p.setup === "function") p.setup();

      function loop() {
        if (typeof p.draw === "function") p.draw();
        global.requestAnimationFrame(loop);
      }
      global.requestAnimationFrame(loop);
    }

    global.p5 = P5;
    global.__p5_fallback__ = true;
  }

  if (global.p5) return;

  var script = document.createElement("script");
  script.src = "https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.min.js";
  script.async = false;
  script.onload = function () {
    global.__p5_fallback__ = false;
  };
  script.onerror = function () {
    installTinyP5();
  };
  document.head.appendChild(script);

  setTimeout(function () {
    if (!global.p5) installTinyP5();
  }, 1200);
})(window);
